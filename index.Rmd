---
title: "Covid-19 CZ: selected data for the Czech Republic"
---

```{r setup, include=F}

knitr::opts_chunk$set(fig.retina = 3, echo = F, eval = T,
                      warning = F,
                      out.width = "90%",
                      dev = "ragg_png",
                      fig.showtext = T,
                      message = F)

knitr::opts_knit$set()

library(stringr)
library(dplyr)
library(ggplot2)
library(czso)
library(CzechData)
library(lubridate)
library(ragg)
library(ptrr)
library(scales)
library(fontawesome)
library(tidyverse)
library(pragr)
library(ggiraph)
library(rmapshaper)

Sys.setlocale("LC_TIME", "cs_CZ.UTF-8")

ptrr::set_geom_defaults()
update_geom_defaults("rect", list(fill = "blue"))
```

```{r fonts}
sysfonts::font_add_google("IBM Plex Sans")
sysfonts::font_add_google("IBM Plex Sans Condensed")
```

```{r metathis}
library(metathis)

meta() %>%
  meta_description(
    "Vybraná data o Covid-19 v ČR"
  ) %>% 
  meta_name("github-repo" = "petrbouchal/covid") %>% 
  meta_viewport() %>% 
  meta_social(
    title = "Covid-19: data for Czech Republic",
    url = "https://petrbouchal.xyz/covid/",
    image = "https://petrbouchal.xyz/covid/twitter_card_large.png",
    image_alt = "Náhled grafu nárůstu případů podle okresů",
    og_type = "website",
    og_author = c("Petr Bouchal"),
    twitter_card_type = "summary_large_image",
    twitter_creator = "@petrbouchal"
  )
```

#  {.tabset}

## Cases: district {.tabset .tabset-pills}

```{r case-data-load}
cisokr <- czso_get_codelist(109) %>% 
  select(okres_lau_kod = CHODNOTA, okres = ZKRTEXT)
ciskraj <- czso_get_codelist(108) %>% 
  select(kraj_nuts_kod = CHODNOTA, kraj = ZKRTEXT)

nhs <- read_csv("https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/nakaza.csv")

nhs_bd <- read_csv("https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/osoby.csv") %>% 
  left_join(cisokr) %>% 
  left_join(ciskraj)

nhs_okr <- read_csv("https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/kraj-okres-nakazeni-vyleceni-umrti.csv") %>% 
  left_join(cisokr) %>% 
  left_join(ciskraj)

umrti <- read_csv("https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/umrti.csv") %>% 
  left_join(cisokr) %>% 
  left_join(ciskraj) %>% 
  mutate(day_sameyear = make_date(1970, month = month(datum),
                                  day = day(datum)),
         day_sameyear_floored = floor_date(day_sameyear, "week"))

epis <- read_csv("https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/kraj-okres-nakazeni-vyleceni-umrti.csv")
```

```{r okresy-geo-load}
okresy_p <- read_rds("okresy_polygons.rds")
```

```{r populace}
obyv_praha <- czso_get_table("130141r20") %>% 
  filter(idhod == "830959865") %>% 
  select(hodnota) %>% 
  mutate(okres_lau_kod = "CZ0100")

obyv_okresy <- czso_get_table("130141r20") %>% 
  filter(vuzemi_cis == "101", vuk_text == "Střední stav obyvatel") %>% 
  left_join(czso_get_codelist(101) %>% 
              select(okres_lau_kod = CZNUTS, vuzemi_kod = CHODNOTA)) %>% 
  rows_insert(obyv_praha) %>% 
  rename(pocobyv = hodnota)
```

```{r model, eval=F}
lm_okres <- function(df) {
  lm(kumulativni_pocet_nakazenych ~ as.numeric(datum), data = df)
}

epis %>% 
  group_by(okres_lau_kod) %>% 
  # mutate(kumulativni_pocet_nakazenych = na_if(kumulativni_pocet_nakazenych, 0)) %>% 
  nest() %>% 
  mutate(model = map(data, lm_okres)) %>% 
  mutate(glance = map(model, broom::glance)) %>% 
  unnest(glance) %>%
  # select(-data, -model) %>% 
  ungroup() %>% 
  skimr::skim()
```

```{r weeks, eval = T}
last_week <- today() - period(1, "week")
last_week_fmt <- ptrr::format_date_human(last_week)
```

```{r narust}
nhs_narust <- nhs_bd %>%
  filter(datum >= last_week) %>%
  group_by(okres, okres_lau_kod, datum) %>% 
  summarise(pocet = n(), .groups = "drop") %>% 
  complete(okres, datum, fill = list(pocet = 0)) %>% 
  drop_na(okres) %>%
  left_join(obyv_okresy %>% select(okres_lau_kod, pocobyv)) %>% 
  group_by(okres) %>% 
  filter(sum(pocet) > 5) %>% 
  arrange(okres, datum) %>%
  mutate(narust = cumsum(pocet), narust_perk = narust/pocobyv * 100000) %>% 
  ungroup() %>% 
  mutate(okres = fct_reorder(okres, narust, max, na.rm = T, .desc = T))
```

```{r days-since-data}
lastpos <- nhs_bd %>% 
  group_by(okres, okres_lau_kod) %>% 
  summarise(last_pos = max(datum)) %>% 
  mutate(days_since_last = today() - last_pos) %>% 
  arrange(desc(days_since_last))

lastwk <- nhs_bd %>% 
  left_join(obyv_okresy %>% select(okres_lau_kod, pocobyv)) %>% 
  drop_na(okres) %>% 
  filter(datum > last_week) %>% 
  group_by(okres, okres_lau_kod) %>% 
  summarise(pocet = n(), pocobyv = mean(pocobyv), pocet_perk = pocet/pocobyv*100000)
```

### Cases last 7 days

```{r map-cases}
library(patchwork)

okresy_percap_plot <- okresy_p %>% 
  left_join(lastwk, by = c("lau1_kod" = "okres_lau_kod")) %>% 
  drop_na(okres) %>%
  mutate(tooltip = paste0(okres, "\n", label_number_cz(1)(pocet_perk))) %>% 
  # replace_na(list(pocet = 0)) %>% 
  ggplot(aes(fill = pocet_perk, data_id = lau1_kod, tooltip = tooltip)) +
  geom_sf_interactive(colour = NA) +
  scale_fill_binned(na.value = "grey", n.breaks = 6,
                    labels = label_number_cz(accuracy = 1),
                    type = "viridis",
                    limits = c(min(lastwk$pocet_perk), max(lastwk$pocet_perk))) +
  guides(fill = guide_bins(title = NULL, direction = "vertical", override.aes = list(colour = NA),
                           show.limits = T, ticks = F, even.steps = T, axis = T, reverse = F)) +
  theme_void() +
  theme(legend.position = "right", legend.justification = 0,
        text = element_text(family = "IBM Plex Sans")) +
  labs(title = "Počet nových případů za posledních 7 dní",
       subtitle = "Na 100 tisíc obyvatel")

okresy_abs_plot <- okresy_p %>% 
  left_join(lastwk, by = c("lau1_kod" = "okres_lau_kod")) %>% 
  drop_na(okres) %>%
  mutate(tooltip = paste0(okres, "\n", label_number_cz(1)(pocet))) %>% 
  # replace_na(list(pocet = 0)) %>% 
  ggplot(aes(fill = pocet, data_id = lau1_kod, tooltip = tooltip)) +
  geom_sf_interactive(colour = NA) +
  scale_fill_binned(na.value = "grey", n.breaks = 7,
                    labels = label_number_cz(accuracy = 1),
                    limits = c(min(lastwk$pocet), max(lastwk$pocet)),
                    type = "viridis"
                    ) +
  guides(fill = guide_bins(title = NULL, direction = "vertical", 
                           override.aes = list(colour = NA),
                           show.limits = T, ticks = F, even.steps = T, axis = T, reverse = F)) +
  theme_void() +
  theme(legend.position = "right", legend.justification = 0,
        text = element_text(family = "IBM Plex Sans")) +
  labs(subtitle = "Absolutně")

girafe(code = print(okresy_percap_plot / okresy_abs_plot), 
       fonts = list(sans = "IBM Plex Sans"), 
       options = list(opts_sizing(width = 1),
                      opts_tooltip(css = "font-family: IBM Plex Sans; color:white; background-color: black; padding:6px;border-radius:5px;"),
                      opts_hover(css = "stroke: white")))
```

### Growth by district since `r last_week_fmt`

```{r narust-plot}
nhs_narust %>% 
  filter(max(pocet, na.rm = T) > 0) %>%
  ggplot(aes(datum, narust)) +
  geom_line(colour = "darkblue", size = 1) +
  geom_point(colour = "darkblue", size = 1.5) +
  facet_wrap(facets = vars(okres), scales = "free_y") +
  scale_y_continuous(expand = expansion(add = c(60, 60))) +
  scale_x_date(labels = label_date_short(format = c(NA, "%b", "%d", "%h")), 
               breaks = breaks_width("2 days")) +
  ptrr::theme_ptrr("y", multiplot = T) +
  theme(axis.text.x = element_text(hjust = 0))
```

```{r narust-tab, eval=F}
nhs_bd %>% 
  filter(datum > "2020-07-13") %>%
  mutate(okr_grp = fct_lump_n(okres, 10, other_level = "Ostatní")) %>%
  drop_na(okr_grp) %>% 
  count(okr_grp, sort = F) %>% 
  ungroup() %>% 
  mutate(okr_grp = fct_reorder(okr_grp, n, .desc = T) %>% 
           fct_relevel("Ostatní", after = Inf)) %>% 
  arrange(okr_grp)
```

```{r map-days-since, eval=F}
### Days since last case in each district
lastpos_ch <- okresy_p %>% 
  left_join(lastpos, by = c("lau1_kod" = "okres_lau_kod")) %>% 
  drop_na(okres)

lastpos_g <- ggplot(lastpos_ch, aes(fill = as.integer(days_since_last))) +
  geom_sf_interactive(aes(data_id = okres, tooltip = paste0(okres, "\n", days_since_last))) +
  scale_fill_binned(na.value = "grey", show.limits = T, n.breaks = 6,
                    type = "viridis",
                    limits = c(min(lastpos_ch$days_since_last),
                               max(lastpos_ch$days_since_last)) %>%
                      as.integer()) +
  guides(fill = guide_coloursteps(even.steps = F,
                                  title = NULL, direction = "horizontal",
                                  show.limits = T, ticks = F)) +
  theme_void() +
  theme(legend.position = c(.8, .8))

girafe(ggobj = lastpos_g, fonts = list(sans = "IBM Plex Sans"), 
       options = list(opts_sizing(width = 1),
                      opts_tooltip(css = "font-family: IBM Plex Sans; color:white; background-color: black; padding:6px;border-radius:5px;"),
                      opts_hover(css = "stroke: white")))
```

## Cases: age {.tabset .tabset-pills}

```{r age-grid}
cases_base <- nhs_bd %>% 
  filter(datum > "2020-08-01", vek < 130) %>% 
  mutate(vek = cut_width(vek, width = 15, boundary = 0, ordered_result = T) %>% 
           fct_relabel(str_remove_all, "\\(|\\)|\\]|\\[") %>% 
           fct_relabel(str_replace, "\\,", " - "),
         pocet = 1)

cases_grid <- cases_base %>% 
  select(datum, kraj, vek) %>% 
  expand(kraj, datum = full_seq(datum, 1), vek)
```

```{r index-1}
make_plot_base <- function(data) {ggplot(data) + 
  guides(fill = guide_colorbar(title.position = "left", barwidth = unit(5, "cm"), 
                               draw.ulim = T, 
                               title.vjust = .75)) +
  ptrr::theme_ptrr(multiplot = F, 
                   axis.text = element_text(colour = "black"),
                   axis.text.x = element_text(hjust = 0),
                   axis.title.x = element_text(hjust = 0, 
                                               margin = margin(c(0.4,0,0,0), "cm")),
                   legend.position = "bottom",
                   legend.margin = unit(c(0,0,0,0), "cm"),
                   legend.box.margin = unit(c(0,0,0,0), "cm"),
                   legend.direction = "horizontal") +
  scale_x_date(date_breaks = "week", labels = label_date_short(),
               expand = expansion(0, 0))}
```

```{r age-heatmap-base}
heatmap_basedt <- cases_grid %>% 
  left_join(cases_base) %>% 
  mutate(week = isoweek(datum),
         datum_orig = datum) %>% 
  mutate(datum =  as.Date(paste(2020, week, 1, sep="-"), "%Y-%U-%u") - days(6))

heatmap_basedt_kraje <- heatmap_basedt %>% 
  group_by(kraj, datum, vek) %>%
  filter(datum > "2020-08-01") %>% 
  summarise(pocet = sum(pocet, na.rm = T)/n_distinct(datum_orig), .groups = "drop") %>% 
  complete(kraj, datum, vek) %>%
  replace_na(replace = list(pocet = 0)) %>% 
  group_by(kraj, datum) %>%
  mutate(all_ages = sum(pocet, na.rm = T)) %>% 
  group_by(kraj, datum) %>%
  mutate(podil = pocet/all_ages) %>% 
  drop_na(kraj)

heatmap_basedt_cr <- heatmap_basedt %>% 
  group_by(datum, vek) %>% 
  filter(datum > "2020-08-01") %>% 
  summarise(pocet = sum(pocet, na.rm = T)/n_distinct(datum_orig), .groups = "drop") %>% 
  complete(datum, vek) %>% 
  replace_na(replace = list(pocet = 0)) %>% 
  group_by(datum) %>% 
  mutate(all_ages = sum(pocet, na.rm = T)) %>% 
  group_by(datum) %>% 
  mutate(podil = pocet/all_ages)
```

### National

```{r age-heatmap-cr-count}
make_plot_base(heatmap_basedt_cr) +
  scale_fill_viridis_c(option = "B", labels = label_number_cz(),
                       n.breaks = 6,
                       name = "Průměrný denní počet nových případů") + 
  geom_tile(aes(datum, vek, fill = pocet)) +
  labs(title = "Nové případy podle věku, po týdnech", x = "Týden začínající...",
       subtitle = "Průměrný denní počet nových případů v daném týdnu")
```

### National (%)

```{r age-heatmap-cr-share}
make_plot_base(heatmap_basedt_cr) +
  scale_fill_viridis_c(option = "B", labels = label_percent_cz(1),
                       name = "Podíl věkové skupiny v daném týdnu") + 
  geom_tile(aes(datum, vek, fill = podil)) +
  guides(fill = guide_colorbar(title.position = "left", barwidth = unit(5, "cm"), 
                               title.vjust = .75)) +
  labs(title = "Věkové složení nových případů po týdnech", subtitle = "",
       x = "Týden začínající...", y = NULL)
```

### By region

```{r age-heatmap-kraje-count}
make_plot_base(heatmap_basedt_kraje) +
  scale_fill_viridis_c(option = "B", labels = label_number_cz(),
                       n.breaks = 6,
                       name = "Denní počet nových případů") + 
  facet_wrap(~ kraj) +
  geom_tile(aes(datum, vek, fill = pocet)) +
  guides(fill = guide_colorbar(title.position = "top", barwidth = unit(5, "cm"))) +
  theme(legend.position = c(.75, .02),
        axis.text = element_text(size = 8)) +
  labs(title = "Nové případy podle věku, po týdnech",
       x = "Týden začínající...")
```

### By region (%)

```{r age-heatmap-kraje-share}
make_plot_base(heatmap_basedt_kraje) +
  scale_fill_viridis_c(option = "B", labels = label_percent_cz(1),
                       name = "Podíl věkové skupiny v daném týdnu") + 
  facet_wrap(~ kraj) +
  geom_tile(aes(datum, vek, fill = podil)) +
  guides(fill = guide_colorbar(title.position = "top", barwidth = unit(5, "cm"))) +
  theme(legend.position = c(.75, .02), , 
        legend.margin = unit(c(0,0,0,0), "cm"),
        legend.direction = "horizontal",
        axis.text = element_text(size = 8)) +
  labs(title = "Věkové složení nových případů po týdnech",
       x = "Týden začínající...")
```

## Deaths: age

```{r index-2}
umrti_base <- umrti %>% 
  mutate(vek = cut_width(vek, width = 10, boundary = 0, ordered_result = T) %>% 
           fct_relabel(str_remove_all, "\\(|\\)|\\]|\\[") %>% 
           fct_relabel(str_replace, "\\,", " - "),
         pocet = 1)

umrti_grid <- umrti_base %>% 
  select(vek, datum) %>% 
  expand(vek, datum = full_seq(datum, 1))

umrti_heatmap_dt <- umrti_grid %>% 
  left_join(umrti_base) %>% 
  mutate(week = isoweek(datum),
         week_starting = as.Date(paste(2020, week, 1, sep="-"), 
                                 "%Y-%U-%u") - days(6)) %>% 
  group_by(week_starting, vek) %>%
  summarise(pocet = sum(pocet, na.rm = T)/n_distinct(datum), 
            .groups = "drop") %>% 
  replace_na(replace = list(pocet = 0)) %>% 
  group_by(week_starting) %>%
  mutate(weekly_total = sum(pocet, na.rm = T)) %>% 
  group_by(week_starting) %>%
  mutate(podil = pocet/weekly_total)

umrti_all_tydny_floored <- umrti_base %>% 
  group_by(day_sameyear_floored) %>% 
  summarise(umrti_covid = n())
```

```{r index-3}
make_plot_base(umrti_heatmap_dt) +
  scale_fill_viridis_c(option = "B", labels = label_number_cz(1),
                       name = "Počet úmrtí v daném týdnu") + 
  geom_tile(aes(week_starting, vek, fill = pocet)) +
  labs(title = "Úmrtí podle věku",
       subtitle = "Průměrný denní počet úmrtní v daném týdnu",
       x = "Týden začínající...")
```

## Mortality: all-cause {.tabset .tabset-pills}

```{r mort-data}
zmr0 <- czso_get_table("130185", force_redownload = T)
zmr <- zmr0 %>% 
  mutate(tyden = as.numeric(tyden),
         casref_do = as.Date(casref_do),
         day_sameyear = make_date(1970, month = month(casref_do),
                                  day = day(casref_do))) %>% 
  mutate(vek_txt = fct_relevel(vek_txt, "celkem"))

last_date_fmt <- ptrr::format_date_human(max(zmr$casref_do))
today_fmt <- ptrr::format_date_human()
```

```{r time-adjusting-load}
vek <- read_rds("vek.rds")
vek_ciselnik <- read_rds("vek_ciselnik.rds")
vek_prevodnik <- read_csv("vek-prevodnik.csv")
```

```{r time-adjusting-agedata}
vek_slct <- vek %>%  
  filter(vuzemi_cis == "97") %>% 
  filter(is.na(pohlavi_txt)) %>% 
  left_join(vek_ciselnik %>%
                    select(vek_kod = CHODNOTA, zkr = ZKRTEXT, 
                           txt = TEXT, matches("MIN|MAX"))) %>% 
  select(idhod, hodnota, vek_txt, zkr, txt, casref_do) %>% 
  left_join(vek_prevodnik) %>% 
  group_by(casref_do, vek_txt = vek_grp) %>% 
  summarise(pocet_obyv = sum(hodnota, na.rm = T)) %>% 
  mutate(rok = year(casref_do)) %>% 
  replace_na(list(vek_txt = "celkem")) %>% 
  ungroup() %>% 
  select(-casref_do)

vek_2019 <- vek_slct %>% 
  filter(rok == 2019, !is.na(vek_txt)) %>% 
  rename(obyv_2019 = pocet_obyv) %>% 
  select(-rok)

vek_do2020 <- vek_slct %>% 
  bind_rows(vek_slct %>% 
              filter(rok == 2019) %>% 
              mutate(rok = 2020))
```

```{r time-adjusting-normalise}
zmr_normd <- zmr %>% 
  filter(vek_txt != "celkem") %>% 
  select(hodnota, rok, tyden, roktyden, vek_txt,
         idhod, stapro_kod, casref_do) %>% 
  left_join(vek_do2020) %>% 
  mutate(per_100k = hodnota/pocet_obyv * 1e5) %>% 
  left_join(vek_2019) %>% 
  mutate(normd = per_100k * obyv_2019 / 1e5)

zmr_normd_with_sum <- zmr_normd %>% 
  bind_rows(zmr_normd %>% 
              group_by(rok, tyden, roktyden, casref_do) %>% 
              summarise(across(c(hodnota, obyv_2019, pocet_obyv, normd), sum)) %>% 
              mutate(per_100k = hodnota/pocet_obyv * 1e5,
                     vek_txt = "celkem")) %>% 
  mutate(day_sameyear = make_date(1970, month(casref_do), day(casref_do)))
```

```{r index-4, eval = F}
ggplot(zmr_normd_with_sum, aes(x = roktyden, colour = vek_txt, group = vek_txt)) +
  geom_line(aes(y = hodnota), size = .3) +
  geom_line(aes(y = normd), linetype = "dashed", size = .3) +
  facet_grid(vek_txt ~ ., scales = "free_y")
```

```{r time-adjusting-prep}
zmr_compare <- zmr_normd_with_sum %>% 
  mutate(is2020 = rok == 2020,
         day_sameyear_floored = floor_date(day_sameyear, "weeks"))
```

```{r time-adjusting-means}
zmr_lastyrs <- zmr_compare %>% 
  filter(rok > 2016) %>%
  group_by(is2020, vek_txt, tyden, 
           day_sameyear_floored) %>% 
  summarise(mean_dead_normd = mean(normd, na.rm = T), 
            mean_pop = mean(pocet_obyv, na.rm = T)) %>% 
  mutate(vek_txt = fct_relevel(vek_txt, "celkem"))
```

```{r time-adjusting-ribbondata}
zmr_ribbon_data <- zmr_normd_with_sum %>% 
  mutate(is2020 = rok == 2020) %>% 
  mutate(day_sameyear_floored = floor_date(day_sameyear, "weeks")) %>% 
  group_by(is2020, vek_txt, tyden, day_sameyear_floored) %>% 
  summarise(min = min(normd, na.rm = T), 
            max = max(normd, na.rm = T), .groups = "drop") %>% 
  mutate(vek_txt = fct_relevel(vek_txt, "celkem"))
```

### Standardised

```{r annotations}
lbls_grey <- tribble(~vek_txt, ~day_sameyear_floored, ~min, ~txt,
               factor("celkem"), as.Date("1970-02-15"), 2750, "rozpětí\n2011-19",
               )
lbls_blue <- tribble(~vek_txt, ~day_sameyear_floored, ~min, ~txt,
               factor("celkem"), as.Date("1970-04-25"), 1900, "2020"
               )
```

```{r age-adjusted-plot, fig.asp=0.6}
ggplot(data = zmr_ribbon_data, mapping = aes(group = vek_txt)) +
  geom_ribbon(data = zmr_ribbon_data %>% filter(!is2020),
              alpha = 0.3,
              aes(x = day_sameyear_floored, ymin = min, ymax = max)) +
  geom_line(data = zmr_ribbon_data %>% filter(is2020),
            colour = "darkblue",
            size = 1,
            aes(x = day_sameyear_floored, y = min)) +
  geom_point(data = zmr_ribbon_data %>% filter(is2020),
            aes(x = day_sameyear_floored, y = min), 
            size = .6, colour = "darkblue", fill = "white", shape = 21) +
  facet_wrap(~vek_txt, scales = "free_y") +
  scale_x_date(date_breaks = "3 months",
               date_labels = "%b", breaks = c(1,3,6, 9, 12)) +
  theme_ptrr("y", multiplot = T) +
  labs(x = "Týden v roce",
       title = "Zemřelí podle týdnů v roce, 2011-2020",
       subtitle = str_glue("Přepočteno na věkovou strukturu roku 2019
                           Údaje do {last_date_fmt}. Modrá = 2020, šedá = rozpětí let 2011-2019"),
       caption = str_glue("Výpočet dle dat ČSÚ, sada 130185 (úmrtí) a 130142 (věk) | @petrbouchal {today_fmt}")) +
  geom_text(data = lbls_grey, aes(x = day_sameyear_floored, 
                            y = min, label = txt), 
            family = "Roboto Condensed",
            fontface = "bold",
            colour = "#454545",size = 2) +
  geom_text(data = lbls_blue, aes(x = day_sameyear_floored, 
                            y = min, label = txt), 
            family = "Roboto Condensed",
            fontface = "bold",
            colour = "darkblue", size = 2)
```


```{r mort-base}
zemr_plot_base <- zmr %>% 
  ggplot(aes(day_sameyear, hodnota,
             alpha = rok == 2020, size = rok == 2020)) +
  geom_line(aes(colour = as.factor(rok), group = rok)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .4), guide = "none") +
  scale_size_manual(values = c(`TRUE` = .7, `FALSE` = .4), guide = "none") +
  scale_colour_viridis_d(direction = -1, name = "rok") +
  ptrr::theme_ptrr("both", multiplot = T, axis.title.x = element_text()) +
  labs(x = "Týden v roce",
       subtitle = str_glue("Údaje do {last_date_fmt}, staženo {today_fmt}"),
       title = "Počty zemřelých podle týdnů v roce, 2011-2020",
       caption = "Data: ČSÚ, sada 130185 | @petrbouchal") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b", breaks = c(1,3,6, 9, 12)) +
  theme(axis.text.x = element_text(hjust = 0))
```

### Raw counts (comparison)

```{r mort-plot-fixed, fig.asp=0.6}
zemr_plot_base +
  facet_wrap(~vek_txt)
```

### Raw counts (detail)

```{r mort-plot-free, fig.asp=0.6}
zemr_plot_base +
  facet_wrap(~vek_txt, scales = "free_y")
```

## Mortality: Covid v. rest {.tabset .tabset-pills}

### Covid and excess deaths

```{r excess-data, include=T}
excess_data <- umrti_all_tydny_floored %>%
  left_join(zmr_lastyrs %>% 
              filter(vek_txt == "celkem")) %>% 
  select(day_sameyear_floored, umrti_covid, mean_dead_normd, is2020) %>% 
  spread(is2020, mean_dead_normd) %>% 
  rename(umrti_mean_lastyrs = `FALSE`, umrti_abs2020 = `TRUE`) %>% 
  mutate(umrti_abs2020_noncovid = umrti_abs2020 - umrti_covid,
         umrti_expected = umrti_mean_lastyrs,
         umrti_excess = umrti_abs2020 - umrti_mean_lastyrs - umrti_covid) 

excess_data_long <- excess_data %>% 
  pivot_longer(c(umrti_covid, umrti_expected,
                 umrti_excess)) %>% 
  mutate(name = fct_relevel(name, 
                            "umrti_excess", 
                            "umrti_covid",
                            "umrti_expected"))

excess_data_daily <- excess_data %>% 
  complete(day_sameyear_floored = full_seq(day_sameyear_floored, period = 1)) %>% 
  mutate(across(starts_with("umrti"), forecast::na.interp)) %>% 
  mutate(umrti_abs2020 = if_else(day_sameyear_floored > max(zmr$day_sameyear[zmr$rok==2020]),
                                NA_real_, umrti_abs2020))
```


```{r excess-plot}
excess_data_daily %>% 
  mutate(excess_spodni = if_else(umrti_mean_lastyrs > umrti_abs2020, 
                                 NA_real_, 
                                 umrti_mean_lastyrs),
         excess_horni = if_else(umrti_mean_lastyrs > umrti_abs2020, 
                                NA_real_, 
                                umrti_abs2020 - umrti_covid)) %>% 
  ggplot(aes(x = day_sameyear_floored)) +
  geom_line(aes(y = umrti_mean_lastyrs, colour = "průměr 2017-19"), size = .5) +
  geom_line(aes(y = umrti_abs2020, colour = "2020"), size = .5) +
  scale_colour_manual(values = c(`průměr 2017-19` = "grey",
                                 `2020` = "blue",
                                 `Nárůst navíc` = "pink", 
                                 `Covid-19` = "lightblue"),
                      name = "Počet zemřelých za týden") +
  geom_ribbon(aes(ymin = umrti_abs2020 - umrti_covid,
                  ymax = umrti_abs2020,
                  fill = "Covid-19")) +
  geom_ribbon(aes(ymin = excess_spodni,
                  ymax = excess_horni,
                  fill = "Nárůst navíc")) +
  scale_fill_manual(values = c(`Nárůst navíc` = "pink", 
                               `Covid-19` = "lightblue"),
                    name = "Příčiny rozdílu") +
  scale_y_continuous(limits = c(0, NA)) +
  theme_ptrr("both") +
  scale_x_date(date_breaks = "month", date_labels = "%d %b") +
  guides(colour = guide_legend(order = 1),
         fill = guide_legend(order = 2)) +
  labs(title = "Úmrtí: Covid-19 a nárůst navíc (excess deaths)",
       subtitle = "Týdenní počty zemřelých: nárůst spojený s Covid-19 x jiné příčiny\nPočty úmrtí 2017-19 přepočteny na věkovou strukturu roku 2019.",
       caption = "@petrbouchal z dat ČSÚ (týdenní počty úmrtí) a MZd (úmrtí na Covid)")


```

#### Alternative view, incl. recent Covid-19 deaths

```{r index-5, eval = T}

date_last_stats <- max(zmr$day_sameyear[zmr$rok == 2020])

ggplot(excess_data_long %>% 
         mutate(alpha = if_else(day_sameyear_floored > date_last_stats, "no", "yes")),
       aes(day_sameyear_floored)) +
  geom_col(aes(y = value, fill = name, alpha = alpha)) +
  # geom_line(aes(y = umrti_mean_lastyrs)) +
  scale_fill_manual(values = c(umrti_excess = "darkred",
                               umrti_covid = "darkblue",
                               umrti_expected = "grey"),
                    labels = c("Nárůst navíc",
                               "Covid-19",
                               "Úroveň let 2017-19"), name = NULL) +
  scale_alpha_discrete(range = c(0.7, 1), guide = "none") +
  theme_ptrr("both") +
  scale_x_date(date_breaks = "month", date_labels = "%d %b") +
  labs(title = "Úmrtí: Covid-19 a nárůst navíc (excess deaths)",
       subtitle = "Týdenní počty zemřelých: nárůst spojený s Covid-19 x jiné příčiny\nPočty úmrtí 2017-19 přepočteny na věkovou strukturu roku 2019. Data o celkové úmrtnosti mají zpoždění.",
       caption = "@petrbouchal z dat ČSÚ (týdenní počty úmrtí) a MZd (úmrtí na Covid)") +
  theme(legend.position = c(.13, .85), legend.key.size = unit(.5, "cm"))
```

### Excess deaths by age

TO DO
### Excess deaths by region

### Causes

TO DO

```{r index-11}

```

## Mobility

## Data & disclaimer

This repository contains code that generates a dashboard using open data on Covid-19 cases and deaths in the Czech Republic, and on all-cause mortality to understand excess deaths.

The goal is to provide some of the comparisons that official sources (e.g. the Czech Health Ministry at https://onemocneni-aktualne.mzcr.cz/covid-19) do not provide - namely a per-district view of recent cases and the age breakdown of cases and deaths over time.

The Covid-19 data comes from UZIS, the Czech health data authority, via data published by the Czech Ministstry of Health at https://onemocneni-aktualne.mzcr.cz/covid-19.

The mortality data comes from the Czech Statistical Office: https://www.czso.cz/csu/czso/obypz_cr. It is reported with a delay of several weeks owing to the manual process of recording and reporting deaths in population registers.

### Important

The data visualisations should be taken with a grain of salt. The data is incomplete and imperfect: it can undergo backward revisions, fresh data sometimes contains errors, and there are issues inherent in how the data is collected and reported (starting from test errors, to reporting errors, to time inconsistencies etc.)

Specifically, daily figures, where reported, are subject to change and significant variation and these should be intepreted with caution. 

# 

Last built on `r format(lubridate::now("CET"), "%Y-%m-%d %H:%M %Z")`
